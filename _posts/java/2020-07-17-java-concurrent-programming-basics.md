---
title: Java 多线程基础.md
tags: 并发,多线程,并行
notebook: Java
---

## 多线程的概念

一个**进程**运行时产生了不止一个**线程（thread）**，或一个程序同时执行多个任务，称为多线程。
操作系统中的多任务，例如在编辑或下载同时打印这种同一时运行多个程序的能力，与要讨论的多线程有什么区别？
本质区别在于：
* 多进程中每个进程有独立的整套变量，而多线程共享数据。
* 线程更轻量级，创建与撤销一个线程比启动新进程的开销要更小。

多线程的应用例如，浏览器同时下载几份图片，服务器要处理多个并发的请求等场景。

### 并行与并发的概念

**串行**: 按照顺序执行

**并行（parallel）**：*真正同时*
多个CPU实例或者多台机器同时执行一段逻辑，严格地同时进行任务

**并发（concurrent）**：*表面同时，资源共用*
通过CPU调度，让用户看上去是同时执行（实际从CPU层面来说不是同时执行的），往往在并发场景会出现资源的共用。

> concurrent and parallel programming what's the difference?
```
            Wait Line 1
 +--------------------------------->+        +----------+
                                    |        |          |
                                    |        |          |
                                    +------->+  Coffee  |    (1) Concurrent
                                             |          |
                                    +------->+          |
           Wait Line 2              |        +----------+
+---------------------------------->+



                                             +-----------+
                                             |           |
             Wait Line 1                     |           |
 +-------------------------------------------> Coffee 1  |
                                             |           |
                                             |           |
                                             +-----------+
                                                               (2) Parallel
                                             +-----------+
                                             |           |
             Wait Line 2                     |           |
 +-------------------------------------------> Coffee 2  |
                                             |           |
                                             |           |
                                             +-----------+
```


> 多线程编程的实质是将任务的处理方式由串行改为并发，发挥并发的优势



### 线程安全与同步的概念

**线程安全**：
代码在并发情况下经过多线程调度和使用，调度的顺序不影响任何结果，称为线程安全。
反之，线程不安全会让调度顺序影响运行结果。

**同步**：
Java中的同步是指**经过人为控制保证共享资源的多线程访问成为线程安全的**，以保证结果的准确。
例如在多线程访问的函数上加上`@synchronized` 标签。

优秀的程序保证结果准确作为前提，提升性能。**线程安全的优先级大于性能**。

Java的同步机制与内存屏障相关：

> **内存屏障**：对一类指令的称呼，该指令可以禁止指令的重排序，但代价是会阻止编译器、处理器做一些性能优化。内存屏障还会导致冲刷缓存器和清空无效队列，比较耗时


__volatile关键字的实现：__

* 有序性的保证机制：

    * Java虚拟机（JIT编译器）在volatile变量读操作之后插入一个获取屏障，保证这个volatile变量读操作先于该屏障之后的任何读写操作被提交

    * 在volatile变量写操作之前插入一个释放屏障，保证该屏障之前的任何读写操作都先于这个volatile变量的写操作被提交


__synchronized关键字的实现：__

* synchronized对原子性的保证：

    * JIT编译器会在monitorenter(用于申请锁的字节码指令)对应的指令后临界区开始前的地方插入一个获取屏障。
    * Java虚拟机会在临界区结束后monitorexit（用于释放锁的字节码指令）对应的指令前的地方插入一个释放屏障。
    * 获取屏障和释放屏障一起保证了临界区内的任何读写操作都无法被重排序到临界区之外，再加上锁的排他性，使得临界区内的操作具有原子性
* 对有序性的保证：
    * 同volatile机制




## 线程状态

`static enum Thread.State`：
* **`NEW` 新创建**

    - 使用`new` 操作符创建新线程时，该线程还没有开始运行，它的状态就是 `NEW`。
* **`RUNNABLE` 可运行**

    - 调用了 `start` 方法，线程处于 `RUNNABLE` 状态。即一个线程可能正在运行也可能没有运行，取决于操作系统给线程提供运行的时间。
* **`BLOCKED` 被阻塞**
* `WAITING` 等待
* `TIME_WAITING` 计时等待
* `TERMINATED` 被终止

确定一个线程的当前状态，可以用 `getState` 方法。
